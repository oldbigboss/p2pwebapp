from aiohttp import web
import aiohttp_jinja2
import jinja2
import json
from database import get_user_raw_settings

app = web.Application()
aiohttp_jinja2.setup(app, loader=jinja2.FileSystemLoader('site\\templates')) 

async def index(request):
    tgid =  request.rel_url.query['id']
    # data = {
    #     'arb_range': [10000, 500000],
    #     'paytypes': [0, 1, 3],
    #     'mt_list': {'bin': ['m'], 'gar': [], 'huo': ['m', 't'], 'byb': ['t']},
    #     'marketlist': ['BTC', 'BUSD', 'BNB', 'USDC', 'ETH', 'DAI'], 
    #     'blacklist': ['rrr','dfdsc']
    # }
    
    def prepare_data(data):
        exchange_key_mapping = {
            'bin': 'binance',
            'huo': 'huobi',
            'byb': 'baybit',
            'gar': 'garantex'
        } 
        new_mt_list = {}
        for key, value in data['mt_list'].items():
            new_key = exchange_key_mapping.get(key, key)
            new_value = [item.upper() for item in value]
            new_mt_list[new_key] = new_value

        data['mt_list'] = new_mt_list

        return data
    data = get_user_raw_settings(tgid)
    prepared_data = prepare_data(data) 
    return aiohttp_jinja2.render_template('test.html', request, {'data': json.dumps(prepared_data)})

app.router.add_get('/', index)
web.run_app(app, host='127.0.0.1', port=8000) 
